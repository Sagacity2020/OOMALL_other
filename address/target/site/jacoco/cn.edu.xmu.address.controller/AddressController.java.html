<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddressController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">address</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.address.controller</a> &gt; <span class="el_source">AddressController.java</span></div><h1>AddressController.java</h1><pre class="source lang-java linenums">package cn.edu.xmu.address.controller;

import cn.edu.xmu.address.model.bo.Address;
import cn.edu.xmu.address.model.bo.Region;
import cn.edu.xmu.address.model.vo.AddressVo;
import cn.edu.xmu.address.model.vo.RegionVo;
import cn.edu.xmu.address.service.AddressService;
import cn.edu.xmu.address.service.RegionService;
import cn.edu.xmu.ooad.annotation.Audit;
import cn.edu.xmu.ooad.annotation.Depart;
import cn.edu.xmu.ooad.annotation.LoginUser;
import cn.edu.xmu.ooad.model.VoObject;
import cn.edu.xmu.ooad.util.Common;
import cn.edu.xmu.ooad.util.ResponseCode;
import cn.edu.xmu.ooad.util.ReturnObject;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.validation.BindingResult;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import springfox.documentation.annotations.ApiIgnore;

import javax.servlet.http.HttpServletResponse;
import javax.xml.stream.events.Comment;
import java.time.LocalDateTime;


@Api(value=&quot;地址&quot;, tags = &quot;Address&quot;)
@RestController
@RequestMapping(value = &quot;/address&quot;,produces = &quot;application/json;charset=UTF-8&quot;)
<span class="fc" id="L35">public class AddressController {</span>

<span class="fc" id="L37">    private static final Logger logger = LoggerFactory.getLogger(AddressController.class);</span>

    @Autowired
    private AddressService addressService;

    @Autowired
    private RegionService regionService;

    @Autowired
    private HttpServletResponse httpServletResponse;

    /**
     * @Created at 2020/11/30 10:36
     * @author zrh
     * @param vo
     * @param bindingResult
     * @param userId
     * @return
     */
    @ApiOperation(value = &quot;新建地址&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(paramType = &quot;header&quot;, dataType = &quot;String&quot;, name = &quot;authrization&quot;, value = &quot;Token&quot;, required = true),
            @ApiImplicitParam(paramType = &quot;body&quot;,dataType =&quot;AddressVo&quot;, name = &quot;vo&quot;,value = &quot;可修改的地址信息&quot;, required = true)
    })
    @ApiResponses({
            @ApiResponse(code = 0,message = &quot;成功&quot;),
            @ApiResponse(code = 601,message = &quot;达到地址簿上限&quot;)
    })
    @Audit
    @PostMapping(&quot;/addresses&quot;)
    public Object createAddress(@Validated @RequestBody AddressVo vo, BindingResult bindingResult,
                                @LoginUser @ApiIgnore Long userId){


<span class="fc" id="L71">        logger.debug(&quot;insert address by userId &quot;+ userId);</span>

<span class="fc" id="L73">        Object returnObject = Common.processFieldErrors(bindingResult,httpServletResponse);</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if(null != returnObject){</span>
<span class="nc" id="L75">            logger.debug(&quot;validate fail&quot;);</span>
<span class="nc" id="L76">            return returnObject;</span>
        }
<span class="fc" id="L78">        Address address = vo.createAddress();</span>
<span class="fc" id="L79">        address.setCustomer_id(userId);</span>
<span class="fc" id="L80">        address.setGmtCreate(LocalDateTime.now());</span>
<span class="fc" id="L81">        ReturnObject retObject = addressService.insertAddress(address);</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (retObject.getData() != null) {</span>
<span class="fc" id="L83">            httpServletResponse.setStatus(HttpStatus.CREATED.value());</span>
<span class="fc" id="L84">            logger.debug(retObject.getData().toString());</span>
<span class="fc" id="L85">            return Common.getRetObject(retObject);</span>
        } else {
<span class="nc" id="L87">            return Common.getNullRetObj(new ReturnObject(retObject.getCode(), retObject.getErrmsg()), httpServletResponse);</span>
        }
    }


    /**
     * @Created at 12/1 0:20
     * @author zrh
     * @param page 页数
     * @param pageSize 每页大小
     */
    @ApiOperation(value = &quot;查询地址&quot;,produces = &quot;application/json&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(paramType = &quot;header&quot;, dataType = &quot;String&quot;, name = &quot;authorization&quot;, value = &quot;Token&quot;, required = true),
            @ApiImplicitParam(paramType = &quot;query&quot;, dataType = &quot;int&quot;, name = &quot;page&quot;, value = &quot;页码&quot;,required = true),
            @ApiImplicitParam(paramType = &quot;query&quot;, dataType = &quot;int&quot;, name = &quot;pageSize&quot;, value = &quot;每页数量&quot;, required = true)
    })
    @ApiResponses({
            @ApiResponse(code = 0, message = &quot;成功&quot;)
    })
    @Audit
    @GetMapping(&quot;/addresses&quot;)
    public Object seleteAllAddress(@LoginUser @ApiIgnore @RequestParam(required = false) Long userId,
        @RequestParam(required = true, defaultValue = &quot;1&quot;) Integer page,
    @RequestParam(required = true,defaultValue = &quot;10&quot;) Integer pageSize){
<span class="fc" id="L112">        logger.debug(&quot;seleteAllAddress: page= &quot;+page+&quot;  pageSize = &quot;+pageSize);</span>
<span class="fc" id="L113">        ReturnObject&lt;PageInfo&lt;VoObject&gt;&gt; returnObject= addressService.selectAllAddreses(userId,page,pageSize);</span>
<span class="fc" id="L114">        return Common.getPageRetObject(returnObject);</span>
    }


    /**
     * @Created at 12/2 14:02
     * @author zrh
     * @param id
     * @return
     */
    @ApiOperation(value = &quot;设置默认地址&quot;,produces = &quot;application/json&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(paramType = &quot;header&quot;,dataType = &quot;String&quot;,name = &quot;authorization&quot;,value = &quot;Token&quot;,required = true),
            @ApiImplicitParam(paramType = &quot;path&quot;,dataType = &quot;Integer&quot;,name = &quot;id&quot;,value = &quot;地址id&quot;,required = true)
    })
    @ApiResponses({
            @ApiResponse(code = 0,message = &quot;成功&quot;)
    })
    @Audit
    @PutMapping(&quot;/addresses/{id}/default&quot;)
    public Object setDefaultAddress(@LoginUser @ApiIgnore @RequestParam(required = false) Long userId,@PathVariable(&quot;id&quot;) Long id){
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if(logger.isDebugEnabled()) {</span>
<span class="fc" id="L136">            logger.debug(&quot;set default address by id&quot; + id);</span>
        }
<span class="fc" id="L138">        ReturnObject returnObject=addressService.setDefaultAddress(userId,id);</span>
<span class="fc" id="L139">        return Common.decorateReturnObject(returnObject);</span>
    }

    /**
     * @Created at 12/3 15:30
     * @author zrh
     * @param userId
     * @param id
     * @param vo
     * @param bindingResult
     * @return
     */
    @ApiOperation(value = &quot;修改地址信息&quot;,produces = &quot;application/json&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(paramType = &quot;header&quot;,dataType = &quot;String&quot;,name = &quot;authorization&quot;,value = &quot;Token&quot;,required = true),
            @ApiImplicitParam(paramType = &quot;path&quot;,dataType = &quot;Integer&quot;,name = &quot;id&quot;,value = &quot;地址id&quot;,required = true),
            @ApiImplicitParam(paramType = &quot;body&quot;,dataType = &quot;AddressVo&quot;,name = &quot;vo&quot;,value = &quot;可修改的地址信息&quot;,required = true)
    })
    @ApiResponses({
            @ApiResponse(code=0,message = &quot;成功&quot;)
    })
    @Audit
    @PutMapping(&quot;addresses/{id}&quot;)
    public Object modifyAddressInfo(@LoginUser @ApiIgnore @RequestParam(required = false) Long userId,
                                    @PathVariable(&quot;id&quot;) Long id,@Validated @RequestBody AddressVo vo,BindingResult bindingResult)
    {
<span class="fc" id="L165">        logger.debug(&quot;update Address by Addressid: &quot;+id);</span>

<span class="fc" id="L167">        Object returnObject=Common.processFieldErrors(bindingResult,httpServletResponse);</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if(returnObject!=null) {</span>
<span class="nc" id="L169">            return returnObject;</span>
        }
<span class="fc" id="L171">        Address address=vo.createAddress();</span>
<span class="fc" id="L172">        address.setCustomer_id(userId);</span>
<span class="fc" id="L173">        address.setId(id);</span>
<span class="fc" id="L174">        address.setGmtModified(LocalDateTime.now());</span>

<span class="fc" id="L176">        ReturnObject retObject=addressService.updateAddress(address);</span>
<span class="fc" id="L177">        return Common.decorateReturnObject(retObject);</span>

    }


    /**
     * @Created at 12/3 19:27
     * @author zrh
     * @param id
     * @return
     */
    @ApiOperation(value = &quot;删除地址&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(name = &quot;authorization&quot;,value = &quot;Token&quot;,required = true,dataType = &quot;String&quot;,paramType = &quot;header&quot;),
            @ApiImplicitParam(name = &quot;id&quot;,value = &quot;地址id&quot;,required = true, dataType = &quot;Integer&quot;,paramType = &quot;path&quot;)

    })
    @ApiResponses({
            @ApiResponse(code = 0,message = &quot;成功&quot;),
    })
    @Audit
    @DeleteMapping(&quot;/addresses/{id}&quot;)
    public Object deleteAddress(@PathVariable Long id){
<span class="fc" id="L200">        logger.debug(&quot;delete address id = &quot;+id);</span>
<span class="fc" id="L201">        ReturnObject returnObject= addressService.deleteAddress(id);</span>
<span class="fc" id="L202">        return Common.decorateReturnObject(returnObject);</span>

    }

    /**
     * @Created at 12/7 1:04
     * @author zrh
     * @param id
     * @return
     */
    @ApiOperation(value = &quot;查询上级地区&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(name = &quot;authorization&quot;,value = &quot;Token&quot;,required = true,dataType = &quot;String&quot;,paramType = &quot;header&quot;),
            @ApiImplicitParam(name = &quot;id&quot;,value = &quot;地区id&quot;,required = true,dataType = &quot;Integer&quot;,paramType = &quot;path&quot;)

    })
    @ApiResponses({
            @ApiResponse(code = 0,message = &quot;成功&quot;)
    })
    @Audit
    @GetMapping(&quot;region/{id}/ancestor&quot;)
    public Object queryParentRegion(@PathVariable Long id){
<span class="fc" id="L224">        logger.debug(&quot;query region id =&quot;+id);</span>
<span class="fc" id="L225">        ReturnObject returnObject=regionService.queryPreRegion(id);</span>
<span class="fc" id="L226">        return Common.decorateReturnObject(returnObject);</span>

    }

    /**
     * @Created at 12/8 23:07
     * @author zrh
     * @param departId
     * @param id
     * @param vo
     * @param bindingResult
     * @return
     */
    @ApiOperation(value = &quot;增加子地区&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(name = &quot;authorization&quot;,value = &quot;Token&quot;,required = true,paramType = &quot;header&quot;,dataType = &quot;String&quot;),
            @ApiImplicitParam(name = &quot;id&quot;,value = &quot;地区id&quot;,required = true,dataType = &quot;Integer&quot;,paramType = &quot;path&quot;),
            @ApiImplicitParam(name = &quot;vo&quot;,value = &quot;新建地区信息&quot;,required = true,dataType = &quot;RegionVo&quot;,paramType = &quot;body&quot;)
    })
    @ApiResponses({
            @ApiResponse(code =0,message = &quot;成功&quot;),
            @ApiResponse(code=602,message = &quot;地区已废弃&quot;)
    })
    @Audit
    @PostMapping(&quot;regions/{id}/subregions&quot;)
    public Object newSubRegion(@Depart @ApiIgnore @RequestParam(required = false)Long departId,  @PathVariable Long id, @Validated @RequestBody RegionVo vo, BindingResult bindingResult){
<span class="nc bnc" id="L252" title="All 2 branches missed.">            if(departId.equals(-2L))</span>
            {
<span class="nc" id="L254">                return Common.decorateReturnObject(new ReturnObject(ResponseCode.FIELD_NOTVALID,String.format(&quot;无权限增加地区&quot;)));</span>
            }
<span class="nc" id="L256">            Object returnObject = Common.processFieldErrors(bindingResult,httpServletResponse);</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if(null!=returnObject){</span>
<span class="nc" id="L258">                return  returnObject;</span>
            }
<span class="nc" id="L260">            logger.debug(&quot;新建地区id：&quot;+id);</span>
<span class="nc" id="L261">            Region region=new Region(vo);</span>
<span class="nc" id="L262">            region.setPid(id);</span>
<span class="nc" id="L263">            region.setGmtCreate(LocalDateTime.now());</span>
<span class="nc" id="L264">            region.setState((byte) 1);</span>
<span class="nc" id="L265">            ReturnObject retObject = regionService.newSubRegion(region);</span>
<span class="nc" id="L266">            return Common.decorateReturnObject(retObject);</span>


    }

    /**
     * @Created at 12/10 18:10
     * @author zrh
     * @param departId
     * @param id
     * @param vo
     * @param bindingResult
     * @return
     */

    @ApiOperation(value = &quot;修改地区&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(name = &quot;authorization&quot;,value = &quot;Tokem&quot;,required = true,paramType = &quot;header&quot;,dataType = &quot;String&quot;),
            @ApiImplicitParam(name = &quot;id&quot;,value = &quot;地区id&quot;,required = true,dataType = &quot;Integer&quot;,paramType = &quot;path&quot;),
            @ApiImplicitParam(name=&quot;vo&quot;,value = &quot;修改地区信息&quot;,required = true,dataType = &quot;RegionVo&quot;,paramType = &quot;body&quot;)

    })
    @ApiResponses({
            @ApiResponse(code=0,message = &quot;成功&quot;),
            @ApiResponse(code=602,message = &quot;地区已废弃&quot;)
    })
    @Audit
    @PutMapping(&quot;/regions/{id}&quot;)
    public Object changeRegion(@Depart @ApiIgnore @RequestParam(required = false)Long departId, @PathVariable Long id, @Validated @RequestBody RegionVo vo,BindingResult bindingResult){
<span class="fc" id="L295">        Object returnObject=Common.processFieldErrors(bindingResult,httpServletResponse);</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if(returnObject!=null) {</span>
<span class="nc" id="L297">            return returnObject;</span>
        }
<span class="fc" id="L299">        logger.debug(&quot;修改地区id：&quot;+id);</span>
//        ReturnObject&lt;Integer&gt; retObject=regionService.isRegion(id);
//        Integer ret=retObject.getData();
//        logger.debug(ret.toString());
//        if(!ret.equals(1)){
//            ReturnObject returnObject1=new ReturnObject(retObject.getCode(),retObject.getErrmsg());
//            return Common.decorateReturnObject(returnObject1);
//        }
<span class="fc" id="L307">        Region region=new Region();</span>
<span class="fc" id="L308">        region.setName(vo.getName());</span>
<span class="fc" id="L309">        region.setId(id);</span>
<span class="fc" id="L310">        region.setPostalCode(vo.getPostalCode());</span>
<span class="fc" id="L311">        ReturnObject returnObject1=regionService.updateRegion(region);</span>
<span class="fc" id="L312">        return  Common.decorateReturnObject(returnObject1);</span>

    }

    /**
     * @Created at 12/10 21:30
     * @author zrh
     * @param departId
     * @param id
     * @return
     */
    @ApiOperation(value = &quot;管理员让地区无效&quot;)
    @ApiImplicitParams({
            @ApiImplicitParam(name = &quot;authorization&quot;,value = &quot;Tokem&quot;,required = true,paramType = &quot;header&quot;,dataType = &quot;String&quot;),
            @ApiImplicitParam(name = &quot;id&quot;,value = &quot;地区id&quot;,required = true,dataType = &quot;Integer&quot;,paramType = &quot;path&quot;)
    })
    @ApiResponses({
            @ApiResponse(code=0,message = &quot;成功&quot;),
            @ApiResponse(code=602,message = &quot;地区已废弃&quot;)
    })
    @Audit
    @DeleteMapping(&quot;/regions/{id}&quot;)
    public Object deleteRegion(@Depart @ApiIgnore @RequestParam(required = false) Long departId,@PathVariable Long id){
<span class="fc" id="L335">            logger.debug(&quot;delete region id  = &quot;+id);</span>

<span class="fc" id="L337">            ReturnObject returnObject=regionService.deleteRegion(id);</span>
<span class="fc" id="L338">            return Common.decorateReturnObject(returnObject);</span>
    }





}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>